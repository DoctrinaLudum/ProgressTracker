{# templates/_season_potential_calendar.html #}
{% if potential_calendar %}

{% macro format_value(value, precision=0, default_char='-') %}
    {% if value is number and value != 0 %}
        {{ ("%." ~ precision ~ "f")|format(value|float) }}
    {% else %}
        {{ default_char }}
    {% endif %}
{% endmacro %}

<div class="card mt-0 shadow-sm">
    <div class="card-header bg-primary text-white">
        <i class="bi bi-calendar-event me-1"></i> Calendário de Potencial Máximo da Temporada ({{ config.SEASONAL_TOKEN_NAME }})
    </div>
    <div class="card-body">
        <p class="small text-muted mb-3">
            Este calendário simula o ganho máximo de {{ config.SEASONAL_TOKEN_NAME }} se todas as atividades fossem completadas com 100% de eficiência,
            considerando um jogador com VIP ativo (bônus de +{{ config.SEASONAL_DELIVERY_BUFFS.vip.bonus_value if config.SEASONAL_DELIVERY_BUFFS and 'vip' in config.SEASONAL_DELIVERY_BUFFS else 'N/A' }} {{ config.SEASONAL_TOKEN_NAME }} por entrega/chore, onde aplicável).
            As "compras virtuais" de itens de buff e desbloqueios de tier são feitas assim que o saldo permite, seguindo a prioridade definida.
            Lembre-se que os ganhos de atividades (Entregas, Chores, Bounties) iniciam em {{ config.DATE_ACTIVITIES_START_YIELDING_TOKENS }}.
            Os dias de <span class="badge bg-danger-subtle text-danger-emphasis rounded-pill">Entrega 2x</span> são <strong>estimados</strong>
            {% if config.DOUBLE_DELIVERY_INTERVAL_DAYS is defined and config.DOUBLE_DELIVERY_DATE is defined %}
                (aproximadamente a cada {{ config.DOUBLE_DELIVERY_INTERVAL_DAYS }} dias a partir de {{ config.DOUBLE_DELIVERY_DATE }})
            {% elif config.DOUBLE_DELIVERY_AVERAGE_INTERVAL_DAYS is defined and config.DOUBLE_DELIVERY_START_DATE is defined %}
                 (aproximadamente a cada {{ config.DOUBLE_DELIVERY_AVERAGE_INTERVAL_DAYS }} dias a partir de {{ config.DOUBLE_DELIVERY_START_DATE }})
            {% else %}
                (com base em um intervalo médio configurado)
            {% endif %}
            e podem não coincidir exatamente com as datas reais do evento no jogo.
        </p>
       
        <div class="table-responsive" id="potentialCalendarTableContainer">

            <table class="table table-sm table-hover table-bordered calendar-table potential-calendar-table">
                <thead class="table-dark sticky-top calendar-sticky-header">
                    <tr>
                        <th scope="col" class="calendar-date-col">Data</th>
                        <th scope="col">Dia Sem.</th>
                        <th scope="col">Dia S.</th>
                        <th scope="col">Saldo Inicial</th>
                        <th scope="col">Baú</th>
                        <th scope="col">Entr. (Base)</th>
                        <th scope="col">Chores (Base)</th>
                        <th scope="col">B.Mega (Base)</th>
                        <th scope="col">B.Anim (Base)</th>
                        <th scope="col">Bônus 100% B.Mega</th>
                        <th scope="col" title="Bônus total de VIP no dia">VIP<br><span class="fw-normal small">(Bônus)</span></th>
                        {% for buff_item_name in sim_buff_item_purchase_priority %}
                            <th scope="col" title="Bônus total de {{ buff_item_name }} no dia">
                                {{ buff_item_name | replace(" ", "<br>") | safe }}<br><span class="fw-normal small">(Bônus)</span>
                            </th>
                        {% endfor %}
                        <th scope="col" class="bg-success text-white">Total Ganhos Dia</th>
                        <th scope="col" class="calendar-purchases-col">Minhas Compras (Manual)</th>
                        <th scope="col">Custo Manual</th>
                        <th scope="col" class="bg-info text-white">Saldo Final</th>
                        <th scope="col" class="calendar-buffs-col">Buffs Ativos</th>
                    </tr>
                </thead>
                <tbody>
                    {% for day_data in potential_calendar %}
                    <tr class="week-{{ 'even' if day_data.game_week_id % 2 == 0 else 'odd' }} {% if day_data.purchases_today %}highlight-purchase-day fw-bold{% endif %}">
                        <td class="calendar-date-col" data-field="date_display">{{ day_data.date_display }}</td>
                        <td data-field="day_of_week_str">{{ day_data.day_of_week_str }}</td>
                        <td data-field="day_in_season">{{ day_data.day_in_season }}</td>
                        <td data-field="balance_start_day">{{ format_value(day_data.balance_start_day) }}</td>
                        <td data-field="gains_chest">{{ format_value(day_data.gains_chest) }}</td>
                        <td>
                            {{ format_value(day_data.gains_deliveries_base) }}
                            {% if day_data.is_double_delivery_day %}
                                <span class="badge bg-danger-subtle text-danger-emphasis rounded-pill ms-1" title="Estimativa de Entregas em Dobro neste dia!">2x</span>
                            {% endif %}
                        </td>
                        <td>{{ format_value(day_data.gains_chores_base) }}</td>
                        <td>{{ format_value(day_data.gains_megaboard_base) }}</td>
                        <td>{{ format_value(day_data.gains_animals_base) }}</td>
                        <td>{{ format_value(day_data.gains_megaboard_completion_bonus) }}</td>
                        {% set vip_tooltip_parts = [] %}
                        {% if day_data.gains_deliveries_vip_bonus %}{% set _ = vip_tooltip_parts.append("Entregas: +" + format_value(day_data.gains_deliveries_vip_bonus, default_char='0')) %}{% endif %}
                        {% if day_data.gains_chores_vip_bonus %}{% set _ = vip_tooltip_parts.append("Chores: +" + format_value(day_data.gains_chores_vip_bonus, default_char='0')) %}{% endif %}
                        <td {% if vip_tooltip_parts %}data-bs-toggle="tooltip" data-bs-placement="top" title="{{ vip_tooltip_parts|join('; ') }}"{% endif %}>
                            {{ "%.0f"|format(day_data.gains_vip_total_bonus) if day_data.gains_vip_total_bonus > 0 else '-' }}
                        </td>
                        {% for buff_item_name in sim_buff_item_purchase_priority %}
                            {% set total_bonus_for_item_today = day_data.item_specific_bonus_totals.get(buff_item_name, 0) %}
                            {% set item_bonus_details_today = day_data.gains_item_bonuses_detailed.get(buff_item_name, {}) %}
                            {% set tooltip_title_parts = [] %}
                            {% if item_bonus_details_today.deliveries %}{% set _ = tooltip_title_parts.append("Entregas: +" + format_value(item_bonus_details_today.deliveries, default_char='0')) %}{% endif %}
                            {% if item_bonus_details_today.chores %}{% set _ = tooltip_title_parts.append("Chores: +" + format_value(item_bonus_details_today.chores, default_char='0')) %}{% endif %}
                            {% if item_bonus_details_today.megaboard_bounties %}{% set _ = tooltip_title_parts.append("B.Mega: +" + format_value(item_bonus_details_today.megaboard_bounties, default_char='0')) %}{% endif %}
                            {% if item_bonus_details_today.animal_bounties %}{% set _ = tooltip_title_parts.append("B.Anim: +" + format_value(item_bonus_details_today.animal_bounties, default_char='0')) %}{% endif %}
                            <td {% if tooltip_title_parts %}data-bs-toggle="tooltip" data-bs-placement="top" title="{{ tooltip_title_parts|join('; ') }}"{% endif %}>
                                {{ format_value(total_bonus_for_item_today) }}
                            </td>
                        {% endfor %}
                        <td class="fw-bold" data-field="total_gains_today">{{ format_value(day_data.total_gains_today) }}</td>
                        <td class="calendar-purchases-col">
                            <div class="manual-purchases-display" data-field="manual_purchases_display">
                                {# Itens comprados manualmente serão listados aqui pelo JS #}
                            </div>
                            <button class="btn btn-xs btn-outline-success mt-1 open-manual-purchase-modal"
                                    data-day-index="{{ loop.index0 }}"
                                    data-date-display="{{ day_data.date_display }}"
                                    title="Registrar compra manual de item neste dia">
                                <i class="bi bi-plus-circle-dotted"></i> Add
                            </button>
                        </td>
                        <td data-field="manual_cost_display" class="text-danger">
                            {# Custo das compras manuais será mostrado aqui pelo JS #}
                        </td>
                        <td class="fw-bold" data-field="balance_end_day">{{ format_value(day_data.balance_end_day) }}</td>
                        <td class="calendar-buffs-col small" data-field="active_buffs_list">
                            {% if day_data.active_buffs_list and day_data.active_buffs_list is iterable and day_data.active_buffs_list is not string %}
                                {% for buff_name in day_data.active_buffs_list %}
                                    <span class="badge bg-secondary fw-normal me-1 mb-1 d-inline-block">{{ buff_name }}</span>
                                {% endfor %}
                            {% elif day_data.active_buffs_str %} {# Fallback para o formato string antigo #}
                                {{ day_data.active_buffs_str | replace(",", ",\n") }}
                            {% else %}
                                -
                            {% endif %}
                        </td>                    
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-warning mt-3" role="alert">
    Os dados do Calendário de Potencial Máximo ainda não estão disponíveis. Se você já buscou um Farm ID, esta funcionalidade é independente e mostra um cenário ideal para a temporada.
    Pode haver uma configuração pendente ou a simulação ainda não foi executada.
</div>
{% endif %}